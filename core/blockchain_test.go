package core

import (
	"github.com/stretchr/testify/assert"
	"testing"
)

var validationServer = "https://crows.sh/verifySignature"

func TestLocalNode_AddTransactionToMemPool(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}

	// Has an invalid signature
	invalidTransaction := Transaction{
		Sender:    "test1",
		Recipient: "test2",
		Amount:    5,
		Timestamp: 0,
		Signature: "",
	}

	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(invalidTransaction, true)

	assert.NotContains(t, localNode.MemPool, invalidTransaction)

	// Has a valid signature
	validTransaction := Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}

	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(validTransaction, true)

	assert.Contains(t, localNode.MemPool, validTransaction)

	// Try adding a duplicate transaction
	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(validTransaction, true)

	// If we have 3 transactions in MemPool, that means we have duplicate transactions!
	if len(localNode.MemPool) == 3 {
		assert.Fail(t, "A duplicate transaction got added!")
	}
}

func TestLocalNode_AddMinedBlockToChain(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}
	localNode.IsMining = true
	newTransactions := []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}
	localNode.MemPool = newTransactions
	newBlock := Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: newTransactions, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}

	// Check the block was valid (without contacting P2P)
	assert.True(t, localNode.AddMinedBlockToChain(newBlock, func() {}))

	// Check that mining has been canceled
	assert.False(t, localNode.IsMining)

	// Check chain has been updated
	assert.Contains(t, localNode.Chain, newBlock)

	// Check UTXO has been updated
	assert.Contains(t, localNode.UTXO, "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c")

	// Check MemPool has been cleared out
	assert.NotContains(t, localNode.MemPool, newTransactions)

	// Make a new block with an invalid previous hash (therefore invalid block)
	newBlock2 := Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: newTransactions, PreviousHash: "-----"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}

	hasPeerConsensusBeenCalled := false

	// Check the block was invalid (without contacting P2P)
	assert.False(t, localNode.AddMinedBlockToChain(newBlock2, func() { hasPeerConsensusBeenCalled = true }))

	// Check that peer consensus function was called
	assert.True(t, hasPeerConsensusBeenCalled)
}

func TestLocalNode_Consensus(t *testing.T) {
	longestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "ec29e9dc0db3378a6abc2b3c2c5dc0325840cf268bef4927211ff09ff35530037739839705c6125698c7142c26ecd0d0e1a0bcf63f3a8e7aa7b1a3c16503028d"}}, PreviousHash: "e5d0735dd18e795b3866178cd63f3fdcaf65a71925289a12db7a9a63952d17e0"}, Proof: Proof{Nonce: 504250, DifficultyThreshold: 5}}}
	secondLongestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}}
	shortestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}}

	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}
	localNode.IsMining = true
	localNode.Consensus(longestChain, secondLongestChain, shortestChain)

	assert.Equal(t, longestChain, localNode.Chain)
	assert.False(t, localNode.IsMining)

	// Try to run consensus where our current chain is the longest
	assert.False(t, localNode.Consensus([]Block{}))
	assert.NotEqual(t, localNode.Chain, []Block{})

	// Try to run consensus where there are no chains
	assert.False(t, localNode.Consensus())
}

func TestLocalNode_MineBlock(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}

	localNode.UTXO["b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c"] = 100000000000000
	localNode.MemPool = []Transaction{Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}
	localNode.IsMining = true
	outputBlock := localNode.MineBlock(&localNode.IsMining)

	// Check that we got a new block
	assert.NotNil(t, outputBlock)
	assert.Contains(t, outputBlock.Transactions, localNode.MemPool[0])

	// Check coinbase transaction is valid
	assert.Equal(t, outputBlock.Transactions[0].Sender, "0")
	assert.Equal(t, outputBlock.Transactions[0].Recipient, localNode.OperatorPublicKey)
	assert.Equal(t, outputBlock.Transactions[0].Amount, coinbaseReward)

	// Check that it didn't update the UTXO for us
	assert.NotContains(t, localNode.UTXO, "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c")

	// Invalid Transaction
	localNode.MemPool = []Transaction{Transaction{Sender: "NOTREALPERSON", Recipient: "OTHERNOTREALPERSON", Amount: 999999, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}
	localNode.IsMining = true
	outputBlock2 := localNode.MineBlock(&localNode.IsMining)
	assert.Nil(t, outputBlock2)
	assert.False(t, localNode.IsMining)

	// Cancel Mining
	localNode.UTXO["b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c"] = 100000000000000
	localNode.MemPool = []Transaction{Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}
	localNode.IsMining = true
	//README NOTE: This test can be a little flaky due to timing with goroutines.
	go func() {
		localNode.IsMining = false
	}()
	outputBlock3 := localNode.MineBlock(&localNode.IsMining)
	assert.Nil(t, outputBlock3)
}

func TestValidateChain(t *testing.T) {
	// Check valid chain
	chain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "ec29e9dc0db3378a6abc2b3c2c5dc0325840cf268bef4927211ff09ff35530037739839705c6125698c7142c26ecd0d0e1a0bcf63f3a8e7aa7b1a3c16503028d"}}, PreviousHash: "e5d0735dd18e795b3866178cd63f3fdcaf65a71925289a12db7a9a63952d17e0"}, Proof: Proof{Nonce: 504250, DifficultyThreshold: 5}}}
	valid, UTXO := ValidateChain(chain, validationServer)
	assert.True(t, valid)
	assert.Contains(t, UTXO, "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c")

	// Check invalid chain
	invalidChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "MADEUPGUY", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "ec29e9dc0db3378a6abc2b3c2c5dc0325840cf268bef4927211ff09ff35530037739839705c6125698c7142c26ecd0d0e1a0bcf63f3a8e7aa7b1a3c16503028d"}}, PreviousHash: "e5d0735dd18e795b3866178cd63f3fdcaf65a71925289a12db7a9a63952d17e0"}, Proof: Proof{Nonce: 504250, DifficultyThreshold: 5}}}
	valid2, UTXO2 := ValidateChain(invalidChain, validationServer)
	assert.False(t, valid2)
	assert.Nil(t, UTXO2)
}

func TestValidateBlock(t *testing.T) {
	chain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "ec29e9dc0db3378a6abc2b3c2c5dc0325840cf268bef4927211ff09ff35530037739839705c6125698c7142c26ecd0d0e1a0bcf63f3a8e7aa7b1a3c16503028d"}}, PreviousHash: "e5d0735dd18e795b3866178cd63f3fdcaf65a71925289a12db7a9a63952d17e0"}, Proof: Proof{Nonce: 504250, DifficultyThreshold: 5}}}

	//README NOTE: The only reason we can pass a blank UTXO in all of these calls to ValidateBlock is because the miner of each block was the sender

	// Fully Valid Block
	validBlock, validUTXO := ValidateBlock(9, chain, make(UTXO), validationServer)
	assert.True(t, validBlock)
	assert.Contains(t, validUTXO, "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c")
	assert.NotContains(t, validUTXO, "0")

	// Valid Genesis Block
	validGenesis, genesisUTXO := ValidateBlock(0, chain, make(UTXO), validationServer)
	assert.True(t, validGenesis)
	assert.Contains(t, genesisUTXO, "b61e63485c4782d6495aa0091c6785d8b6c0a945a23d9b158093bbf3d93d6bb9024e6cab467cc11b51e1b1a158637a778473418298b09a7dd39c148863b1833c")
	assert.NotContains(t, genesisUTXO, "0")

	// Invalid Genesis Block
	chain[0] = Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "NOTREALPERSON", Amount: 1, Timestamp: 1585852961, Signature: ""}}}}
	invalidGenesis, invalidGenesisUTXO := ValidateBlock(0, chain, make(UTXO), validationServer)
	assert.False(t, invalidGenesis)
	assert.Nil(t, invalidGenesisUTXO)

	// Block With Only Coinbase Transaction
	chain[1].Transactions = []Transaction{Transaction{Sender: "0", Recipient: "NOTREALPERSON", Amount: 1, Timestamp: 1585852961, Signature: ""}}
	blockWithOnlyGenesisTransactionValid, invalidBlockUTXO := ValidateBlock(1, chain, make(UTXO), validationServer)
	assert.False(t, blockWithOnlyGenesisTransactionValid)
	assert.Nil(t, invalidBlockUTXO)

	// Block With Invalid Difficulty
	chain[2].Proof.DifficultyThreshold = 999
	blockWithInvalidDifficulty, invalidDifficultyUTXO := ValidateBlock(2, chain, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidDifficulty)
	assert.Nil(t, invalidDifficultyUTXO)

	// Block With Invalid Coinbase Transaction
	chain[3].Transactions[0].Amount = coinbaseReward + 9999
	chain[3].PreviousHash = chain[2].hash()
	chain[3].Proof.Nonce = 3142330
	blockWithInvalidCoinbaseTransaction, invalidCoinbaseUTXO := ValidateBlock(3, chain, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidCoinbaseTransaction)
	assert.Nil(t, invalidCoinbaseUTXO)

	// Block With Invalid Previous Hash
	chain[4].PreviousHash = "NOTVALID"
	blockWithInvalidPreviousHash, invalidPreviousHashUTXO := ValidateBlock(4, chain, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidPreviousHash)
	assert.Nil(t, invalidPreviousHashUTXO)

	// Block With Invalid Signature
	chain[5].PreviousHash = chain[4].hash()
	chain[5].Transactions[1].Signature = "NOTVALID"
	chain[5].Proof.Nonce = 1958177
	blockWithInvalidSignature, invalidSignatureHashUTXO := ValidateBlock(5, chain, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidSignature)
	assert.Nil(t, invalidSignatureHashUTXO)

	// Block With Duplicate Transaction
	chain[6].PreviousHash = chain[5].hash()
	chain[6].Transactions[1] = chain[2].Transactions[1]
	chain[6].Proof.Nonce = 994277
	blockWithDuplicateTransaction, duplicateTransactionUTXO := ValidateBlock(6, chain, make(UTXO), validationServer)
	assert.False(t, blockWithDuplicateTransaction)
	assert.Nil(t, duplicateTransactionUTXO)
}
