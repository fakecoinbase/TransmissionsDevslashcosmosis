package core

import (
	"github.com/stretchr/testify/assert"
	"testing"
)

var validationServer = "https://crows.sh/verifySignature"

func copyChain(originalSlice []Block) []Block {
	b := make([]Block, len(originalSlice))
	copy(b, originalSlice)

	return b
}

func TestLocalNode_AddTransactionToMemPool(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}

	// Has an invalid signature
	invalidTransaction := Transaction{
		Sender:    "test1",
		Recipient: "test2",
		Amount:    5,
		Timestamp: 0,
		Signature: "",
	}

	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(invalidTransaction, true)

	assert.NotContains(t, localNode.MemPool, invalidTransaction)

	// Has a valid signature
	validTransaction := Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "0436c6797970ef164ecb4c279c32e25b866af78fece9cacc3cc94789b5a2ca6229fe21905d734100236fe5520696d8df70d64fdaef606e6880a424c957ae3f9cb6", Amount: 20, Timestamp: 1586468611, Signature: "3046022100f1aaf385f0ad877f733214e0c07f7b00a68227bc5ce73c71fa4df420cc143d2e022100d41e010219b78805a4f45ef81e9ce8fcd77844f952578fb3dfbd44a4fa424469"}

	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(validTransaction, true)

	assert.Contains(t, localNode.MemPool, validTransaction)

	// Try adding a duplicate transaction
	// Add transaction without broadcasting to P2P
	localNode.AddTransactionToMemPool(validTransaction, true)

	// If we have 3 transactions in MemPool, that means we have duplicate transactions!
	if len(localNode.MemPool) == 3 {
		assert.Fail(t, "A duplicate transaction got added!")
	}
}

func TestLocalNode_AddMinedBlockToChain(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}
	localNode.IsMining = true
	newTransactions := []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "0436c6797970ef164ecb4c279c32e25b866af78fece9cacc3cc94789b5a2ca6229fe21905d734100236fe5520696d8df70d64fdaef606e6880a424c957ae3f9cb6", Amount: 20, Timestamp: 1586469742, Signature: "304502201d7519147c9d1f8f2b916683afac3d190ab50688a5c12dd016554a1386f5975c022100ef3938bb6d4d3e6237462b045edcfcc9ef64e9e9f39b869e4ed477ae0d3330e5"}}
	localNode.MemPool = newTransactions
	newBlock := Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: newTransactions, PreviousHash: GenesisBlock.hash()}, Proof: Proof{Nonce: 2119721, DifficultyThreshold: 5}}

	// Check the block was valid (without contacting P2P)
	assert.True(t, localNode.AddMinedBlockToChain(newBlock, func() {}))

	// Check that mining has been canceled
	assert.False(t, localNode.IsMining)

	// Check chain has been updated
	assert.Contains(t, localNode.Chain, newBlock)

	// Check UTXO has been updated
	assert.Contains(t, localNode.UTXO, "0436c6797970ef164ecb4c279c32e25b866af78fece9cacc3cc94789b5a2ca6229fe21905d734100236fe5520696d8df70d64fdaef606e6880a424c957ae3f9cb6")

	// Check MemPool has been cleared out
	assert.NotContains(t, localNode.MemPool, newTransactions)

	// Make a new block with an invalid previous hash (therefore invalid block)
	newBlock2 := Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: newTransactions, PreviousHash: "-----"}}

	hasPeerConsensusBeenCalled := false

	// Check the block was invalid (without contacting P2P)
	assert.False(t, localNode.AddMinedBlockToChain(newBlock2, func() { hasPeerConsensusBeenCalled = true }))

	// Check that peer consensus function was called
	assert.True(t, hasPeerConsensusBeenCalled)
}

func TestLocalNode_Consensus(t *testing.T) {
	secondLongestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}, PreviousHash: "a5b4f08485f4580e2358a50f495cdd4c4e4e383bebff1544cf99245770352d60"}, Proof: Proof{Nonce: 1777869, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "3046022100e832f48b330701fe1cfc53946d42b6ba4465383511b0fa24ebdf6141035a7184022100afaffd679dbc17d8ecd33c1b5a95bfff56ec8e08c471a05446eb6bbe81da0e48"}}, PreviousHash: "d7d142a5bcf2513fcd639438920f46ee62f53954d8a3530c6d193312fee76688"}, Proof: Proof{Nonce: 199169, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "304502200acf2f6eb3169b6d4d7ca28a55cbb64ef91ac2e55943c0f0b55d67a151baf097022100eab71b2f289e8feedd1899d8a65f7f1190073133fa7cdc728209fa8615bce286"}}, PreviousHash: "2f9a66a3361b628ef3f9bd6ce657375eea370cb41428eb5ae7c530c37c935456"}, Proof: Proof{Nonce: 1531439, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "30440220668995bb74c17b0a9da0772f7f21c4a36ebe5739ae2eeda385bb2ca891a79e5402203090f57536eec6a5dd6cf3e3629b9738c38cafea71195b021c4ddeba49454396"}}, PreviousHash: "a8b6009a30eceaef14e042a3b407d4f9ee7eced6afa57291ff02ad0575d31f03"}, Proof: Proof{Nonce: 4573631, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "3046022100dfaa90118a615bd164f7ce5bbad595b13c89e0913328c69f60237c4f7c4f1dc80221009d1f1e5c5cbfd4305780549f4d09a7aff6e81b4d8a6faf499e3789a7bf183e8a"}}, PreviousHash: "1b0ebdcd3eb6ee8fcf4baabc512ae79ab4dc3ca461822f251f70c235bcf2d65c"}, Proof: Proof{Nonce: 603227, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "304502205eb70b3490b02690f14e46bdabf284030e6208cf64104433f9256960ceffbe09022100e5647081dd948589a736f65e7f94a394ecdc0ca3cd2a0549f93327084df9cb7e"}}, PreviousHash: "0c5fb0e4634d1be9b18c872c34bc6fe6d5abd1d7892c393a574a9f7cd2d5f65f"}, Proof: Proof{Nonce: 2223280, DifficultyThreshold: 5}}}
	longestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}, PreviousHash: "a5b4f08485f4580e2358a50f495cdd4c4e4e383bebff1544cf99245770352d60"}, Proof: Proof{Nonce: 1777869, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "3046022100e832f48b330701fe1cfc53946d42b6ba4465383511b0fa24ebdf6141035a7184022100afaffd679dbc17d8ecd33c1b5a95bfff56ec8e08c471a05446eb6bbe81da0e48"}}, PreviousHash: "d7d142a5bcf2513fcd639438920f46ee62f53954d8a3530c6d193312fee76688"}, Proof: Proof{Nonce: 199169, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "304502200acf2f6eb3169b6d4d7ca28a55cbb64ef91ac2e55943c0f0b55d67a151baf097022100eab71b2f289e8feedd1899d8a65f7f1190073133fa7cdc728209fa8615bce286"}}, PreviousHash: "2f9a66a3361b628ef3f9bd6ce657375eea370cb41428eb5ae7c530c37c935456"}, Proof: Proof{Nonce: 1531439, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "30440220668995bb74c17b0a9da0772f7f21c4a36ebe5739ae2eeda385bb2ca891a79e5402203090f57536eec6a5dd6cf3e3629b9738c38cafea71195b021c4ddeba49454396"}}, PreviousHash: "a8b6009a30eceaef14e042a3b407d4f9ee7eced6afa57291ff02ad0575d31f03"}, Proof: Proof{Nonce: 4573631, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "3046022100dfaa90118a615bd164f7ce5bbad595b13c89e0913328c69f60237c4f7c4f1dc80221009d1f1e5c5cbfd4305780549f4d09a7aff6e81b4d8a6faf499e3789a7bf183e8a"}}, PreviousHash: "1b0ebdcd3eb6ee8fcf4baabc512ae79ab4dc3ca461822f251f70c235bcf2d65c"}, Proof: Proof{Nonce: 603227, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "304502205eb70b3490b02690f14e46bdabf284030e6208cf64104433f9256960ceffbe09022100e5647081dd948589a736f65e7f94a394ecdc0ca3cd2a0549f93327084df9cb7e"}}, PreviousHash: "0c5fb0e4634d1be9b18c872c34bc6fe6d5abd1d7892c393a574a9f7cd2d5f65f"}, Proof: Proof{Nonce: 2223280, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "3044022061d0207613c79f4ef804962f4788e39e58899c221546c4d3584fa9cb3ba938680220631066c5741c3a27de5e1f246b3ee3270f0daa93bdf31412f823d49f65c10700"}}, PreviousHash: "c7d2280b20a35eb977d881b4dd7d20edc6681d183ab82d230656b8b76dc82c23"}, Proof: Proof{Nonce: 1376188, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "304402206ff8237cd53d3ba3000dea2f898f146a67d9f8d52842d22612e2f5e384f7ce24022049d0bf48d92d9ea95e2e3aa07dcf02adcab7e7b6127bf1d1e97efc9c512af97f"}}, PreviousHash: "7fbc21aa7a5d5aab5af7c446dab3daf3bf590ea2f9915e4a9ef2432fee0b5ad0"}, Proof: Proof{Nonce: 2248352, DifficultyThreshold: 5}}}
	shortestChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}, PreviousHash: "a5b4f08485f4580e2358a50f495cdd4c4e4e383bebff1544cf99245770352d60"}, Proof: Proof{Nonce: 1777869, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "3046022100e832f48b330701fe1cfc53946d42b6ba4465383511b0fa24ebdf6141035a7184022100afaffd679dbc17d8ecd33c1b5a95bfff56ec8e08c471a05446eb6bbe81da0e48"}}, PreviousHash: "d7d142a5bcf2513fcd639438920f46ee62f53954d8a3530c6d193312fee76688"}, Proof: Proof{Nonce: 199169, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "304502200acf2f6eb3169b6d4d7ca28a55cbb64ef91ac2e55943c0f0b55d67a151baf097022100eab71b2f289e8feedd1899d8a65f7f1190073133fa7cdc728209fa8615bce286"}}, PreviousHash: "2f9a66a3361b628ef3f9bd6ce657375eea370cb41428eb5ae7c530c37c935456"}, Proof: Proof{Nonce: 1531439, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "30440220668995bb74c17b0a9da0772f7f21c4a36ebe5739ae2eeda385bb2ca891a79e5402203090f57536eec6a5dd6cf3e3629b9738c38cafea71195b021c4ddeba49454396"}}, PreviousHash: "a8b6009a30eceaef14e042a3b407d4f9ee7eced6afa57291ff02ad0575d31f03"}, Proof: Proof{Nonce: 4573631, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "3046022100dfaa90118a615bd164f7ce5bbad595b13c89e0913328c69f60237c4f7c4f1dc80221009d1f1e5c5cbfd4305780549f4d09a7aff6e81b4d8a6faf499e3789a7bf183e8a"}}, PreviousHash: "1b0ebdcd3eb6ee8fcf4baabc512ae79ab4dc3ca461822f251f70c235bcf2d65c"}, Proof: Proof{Nonce: 603227, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "304502205eb70b3490b02690f14e46bdabf284030e6208cf64104433f9256960ceffbe09022100e5647081dd948589a736f65e7f94a394ecdc0ca3cd2a0549f93327084df9cb7e"}}, PreviousHash: "0c5fb0e4634d1be9b18c872c34bc6fe6d5abd1d7892c393a574a9f7cd2d5f65f"}, Proof: Proof{Nonce: 2223280, DifficultyThreshold: 5}}}

	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}
	localNode.IsMining = true
	localNode.Consensus(longestChain, secondLongestChain, shortestChain)

	assert.Equal(t, longestChain, localNode.Chain)
	assert.False(t, localNode.IsMining)

	// Try to run consensus where our current chain is the longest
	assert.False(t, localNode.Consensus([]Block{}))
	assert.NotEqual(t, localNode.Chain, []Block{})

	// Try to run consensus where there are no chains
	assert.False(t, localNode.Consensus())
}

func TestLocalNode_MineBlock(t *testing.T) {
	localNode := LocalNode{Chain: []Block{GenesisBlock}, MemPool: make([]Transaction, 0), UTXO: make(UTXO), ValidationServerURL: validationServer, OperatorPublicKey: "0", MinimumChainsForConsensus: 1}

	localNode.UTXO["0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0"] = 100000000000000
	localNode.MemPool = []Transaction{Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}
	localNode.IsMining = true
	outputBlock := localNode.MineBlock(&localNode.IsMining)

	// Check that we got a new block
	assert.NotNil(t, outputBlock)
	assert.Contains(t, outputBlock.Transactions, localNode.MemPool[0])

	// Check coinbase transaction is valid
	assert.Equal(t, outputBlock.Transactions[0].Sender, "0")
	assert.Equal(t, outputBlock.Transactions[0].Recipient, localNode.OperatorPublicKey)
	assert.Equal(t, outputBlock.Transactions[0].Amount, coinbaseReward)

	// Check that it didn't update the UTXO for us
	assert.NotContains(t, localNode.UTXO, "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c")

	// Invalid Transactions Don't Make It Into Blocks (Stay in MemPool)
	invalidTransaction := Transaction{Sender: "NOTREALPERSON", Recipient: "OTHERNOTREALPERSON", Amount: 999999, Timestamp: 1586117966, Signature: "wrong signature"}
	localNode.MemPool = []Transaction{invalidTransaction, invalidTransaction}
	localNode.IsMining = true
	outputBlock2 := localNode.MineBlock(&localNode.IsMining)
	assert.Nil(t, outputBlock2)
	assert.False(t, localNode.IsMining)
	assert.Contains(t, localNode.MemPool, invalidTransaction)

	// Cancel Mining
	localNode.UTXO["0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0"] = 100000000000000
	localNode.MemPool = []Transaction{Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}
	localNode.IsMining = true

	// NOTE: This test can be a little flaky due to timing with goroutines.
	go func() {
		localNode.IsMining = false
	}()
	outputBlock3 := localNode.MineBlock(&localNode.IsMining)
	assert.Nil(t, outputBlock3)
}

func TestValidateChain(t *testing.T) {
	// Check valid chain
	chain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}, PreviousHash: "a5b4f08485f4580e2358a50f495cdd4c4e4e383bebff1544cf99245770352d60"}, Proof: Proof{Nonce: 1777869, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "3046022100e832f48b330701fe1cfc53946d42b6ba4465383511b0fa24ebdf6141035a7184022100afaffd679dbc17d8ecd33c1b5a95bfff56ec8e08c471a05446eb6bbe81da0e48"}}, PreviousHash: "d7d142a5bcf2513fcd639438920f46ee62f53954d8a3530c6d193312fee76688"}, Proof: Proof{Nonce: 199169, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "304502200acf2f6eb3169b6d4d7ca28a55cbb64ef91ac2e55943c0f0b55d67a151baf097022100eab71b2f289e8feedd1899d8a65f7f1190073133fa7cdc728209fa8615bce286"}}, PreviousHash: "2f9a66a3361b628ef3f9bd6ce657375eea370cb41428eb5ae7c530c37c935456"}, Proof: Proof{Nonce: 1531439, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "30440220668995bb74c17b0a9da0772f7f21c4a36ebe5739ae2eeda385bb2ca891a79e5402203090f57536eec6a5dd6cf3e3629b9738c38cafea71195b021c4ddeba49454396"}}, PreviousHash: "a8b6009a30eceaef14e042a3b407d4f9ee7eced6afa57291ff02ad0575d31f03"}, Proof: Proof{Nonce: 4573631, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "3046022100dfaa90118a615bd164f7ce5bbad595b13c89e0913328c69f60237c4f7c4f1dc80221009d1f1e5c5cbfd4305780549f4d09a7aff6e81b4d8a6faf499e3789a7bf183e8a"}}, PreviousHash: "1b0ebdcd3eb6ee8fcf4baabc512ae79ab4dc3ca461822f251f70c235bcf2d65c"}, Proof: Proof{Nonce: 603227, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "304502205eb70b3490b02690f14e46bdabf284030e6208cf64104433f9256960ceffbe09022100e5647081dd948589a736f65e7f94a394ecdc0ca3cd2a0549f93327084df9cb7e"}}, PreviousHash: "0c5fb0e4634d1be9b18c872c34bc6fe6d5abd1d7892c393a574a9f7cd2d5f65f"}, Proof: Proof{Nonce: 2223280, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "3044022061d0207613c79f4ef804962f4788e39e58899c221546c4d3584fa9cb3ba938680220631066c5741c3a27de5e1f246b3ee3270f0daa93bdf31412f823d49f65c10700"}}, PreviousHash: "c7d2280b20a35eb977d881b4dd7d20edc6681d183ab82d230656b8b76dc82c23"}, Proof: Proof{Nonce: 1376188, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "304402206ff8237cd53d3ba3000dea2f898f146a67d9f8d52842d22612e2f5e384f7ce24022049d0bf48d92d9ea95e2e3aa07dcf02adcab7e7b6127bf1d1e97efc9c512af97f"}}, PreviousHash: "7fbc21aa7a5d5aab5af7c446dab3daf3bf590ea2f9915e4a9ef2432fee0b5ad0"}, Proof: Proof{Nonce: 2248352, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "3045022100e8cdfe3a9a87a2eda134f2fa34d286cfaeb1710bda348436f8fe177739444d0d0220089ef5c7e6aa1ce9c10ae2d217f833d0aab339cbefa81a7379f5957745302e02"}}, PreviousHash: "4a86c8870f5bbee49bb0184a0956df6bbea1a7d411a1f4dcb8fa31ed7a1ac5ca"}, Proof: Proof{Nonce: 970577, DifficultyThreshold: 5}}}

	valid, UTXO := ValidateChain(chain, validationServer)
	assert.True(t, valid)
	assert.Contains(t, UTXO, "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c")

	// Check invalid chain
	invalidChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "MADEUPGUY", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "f5f036c0117dd360e57affe1ad76cdb7486f6befd44a8aa201a6713426dd77891ee7263ee2b62449f44ac56f1a83caf9f813727f91f0e66d3da8ed96846e8d4d"}}, PreviousHash: "b83312421b34ba8bc36351d52df47abb6f3c9284897f890fdece2b561859eeb5"}, Proof: Proof{Nonce: 659410, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "96861e9d1f5220fdbf252aa66f75db23432c7811f2cbca2084169aab25eecad5ef510d266027c8abf11258d1752c66f89f4c3029e9d82440f3a0644e22976ecd"}}, PreviousHash: "d23ab3385e2c831b3237a0d4dd13217ecc3d4e3dbc744b7f413ea417d2c7daf5"}, Proof: Proof{Nonce: 10354, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "969f4bb0d115326556c02e8e7c778bd0c277802169244db7b1a7c8d805ffdf0b7904aa538c2b47195e52aac0d4ccc537d60fb709914727406e289f679a101f5f"}}, PreviousHash: "1ad15c8ce88cee8bc2574db12e58179fd17792a4fe274ca476049191a03be8c7"}, Proof: Proof{Nonce: 935594, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "0fce4e6414be70a9ff86d3341f4548dc88a3ae25779642345e3ac2a34c8fd911cda9a2aa25ad96014f9622c66197d88ebddbfc8a21801696d2c550cb72239021"}}, PreviousHash: "b92a8300ee74be5b84b17a07c6891e19248347935d2b3203c4786ef321f9736f"}, Proof: Proof{Nonce: 407734, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "9941680b286d9f5f823b9e4caad9b1cb14a1ae73f83602ebf5ecce7f1ff2123978fc244cad420a8fdb105309f758aee077fdb494faf1b3c24e65e6394a6cce7b"}}, PreviousHash: "f4be57caa9517dce64a8ef7698de0ed3ec75b3e266dc37e7e46d6041619fcbf7"}, Proof: Proof{Nonce: 493872, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "bcfb797cc4888b637c8c5c53540890fa4561e324fd90cf68d720d33f64e3d787493c9acc303641f8e2784c4e349ad77dd19ac5f02d3aa59f71b4128141c34af6"}}, PreviousHash: "0ae307b67e2b710e2580e35fe9fc506977630c6544991e9b484d007d3e6de635"}, Proof: Proof{Nonce: 744179, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "235b7d142548f2d15960fecd7371c53eed692f1ec0b94eb818eea4d0efe8e211cec3edfd09780a7274cb6f4bc198bfca73bbbe1a2f9f73849d3947849a078efd"}}, PreviousHash: "1879968ce0991f7500f34befcebd8cc9d0c172f864b5b6c90201d8ba50a20840"}, Proof: Proof{Nonce: 1338331, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "aa06de4f03bfae22de9ec0f0c65771306ee9844d76bc680a49e197ee217de73b02e022bab118f07d86b360e3ff67b28997e1ad6431df049ca1c5bc41a9ce354f"}}, PreviousHash: "2ac5cc3064b7c17d57abcc15808268b3ae9c03db793a36bfdfdff55275ce5a8c"}, Proof: Proof{Nonce: 694503, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "6007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "ec29e9dc0db3378a6abc2b3c2c5dc0325840cf268bef4927211ff09ff35530037739839705c6125698c7142c26ecd0d0e1a0bcf63f3a8e7aa7b1a3c16503028d"}}, PreviousHash: "e5d0735dd18e795b3866178cd63f3fdcaf65a71925289a12db7a9a63952d17e0"}, Proof: Proof{Nonce: 504250, DifficultyThreshold: 5}}}
	valid2, UTXO2 := ValidateChain(invalidChain, validationServer)
	assert.False(t, valid2)
	assert.Nil(t, UTXO2)
}

func TestValidateBlock(t *testing.T) {
	cleanChain := []Block{Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 100000000000000, Timestamp: 1585852961, Signature: ""}}, PreviousHash: ""}, Proof: Proof{Nonce: 0, DifficultyThreshold: 0}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119312, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586117966, Signature: "3046022100d158259aae3c7c9e3e6cd33a3b47134723ddc4cae25484e8a5df28f45ee462fd022100b6c6600f89a3ef050a8aab14c8a96ca5b5b9c8fa358945c9f53dda1b488dd43c"}}, PreviousHash: "a5b4f08485f4580e2358a50f495cdd4c4e4e383bebff1544cf99245770352d60"}, Proof: Proof{Nonce: 1777869, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119372, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119287, Signature: "3046022100e832f48b330701fe1cfc53946d42b6ba4465383511b0fa24ebdf6141035a7184022100afaffd679dbc17d8ecd33c1b5a95bfff56ec8e08c471a05446eb6bbe81da0e48"}}, PreviousHash: "d7d142a5bcf2513fcd639438920f46ee62f53954d8a3530c6d193312fee76688"}, Proof: Proof{Nonce: 199169, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119432, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 15, Timestamp: 1586119336, Signature: "304502200acf2f6eb3169b6d4d7ca28a55cbb64ef91ac2e55943c0f0b55d67a151baf097022100eab71b2f289e8feedd1899d8a65f7f1190073133fa7cdc728209fa8615bce286"}}, PreviousHash: "2f9a66a3361b628ef3f9bd6ce657375eea370cb41428eb5ae7c530c37c935456"}, Proof: Proof{Nonce: 1531439, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119492, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 16, Timestamp: 1586119430, Signature: "30440220668995bb74c17b0a9da0772f7f21c4a36ebe5739ae2eeda385bb2ca891a79e5402203090f57536eec6a5dd6cf3e3629b9738c38cafea71195b021c4ddeba49454396"}}, PreviousHash: "a8b6009a30eceaef14e042a3b407d4f9ee7eced6afa57291ff02ad0575d31f03"}, Proof: Proof{Nonce: 4573631, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119552, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119465, Signature: "3046022100dfaa90118a615bd164f7ce5bbad595b13c89e0913328c69f60237c4f7c4f1dc80221009d1f1e5c5cbfd4305780549f4d09a7aff6e81b4d8a6faf499e3789a7bf183e8a"}}, PreviousHash: "1b0ebdcd3eb6ee8fcf4baabc512ae79ab4dc3ca461822f251f70c235bcf2d65c"}, Proof: Proof{Nonce: 603227, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119612, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 17, Timestamp: 1586119543, Signature: "304502205eb70b3490b02690f14e46bdabf284030e6208cf64104433f9256960ceffbe09022100e5647081dd948589a736f65e7f94a394ecdc0ca3cd2a0549f93327084df9cb7e"}}, PreviousHash: "0c5fb0e4634d1be9b18c872c34bc6fe6d5abd1d7892c393a574a9f7cd2d5f65f"}, Proof: Proof{Nonce: 2223280, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119732, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 18, Timestamp: 1586119598, Signature: "3044022061d0207613c79f4ef804962f4788e39e58899c221546c4d3584fa9cb3ba938680220631066c5741c3a27de5e1f246b3ee3270f0daa93bdf31412f823d49f65c10700"}}, PreviousHash: "c7d2280b20a35eb977d881b4dd7d20edc6681d183ab82d230656b8b76dc82c23"}, Proof: Proof{Nonce: 1376188, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119792, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 19, Timestamp: 1586119687, Signature: "304402206ff8237cd53d3ba3000dea2f898f146a67d9f8d52842d22612e2f5e384f7ce24022049d0bf48d92d9ea95e2e3aa07dcf02adcab7e7b6127bf1d1e97efc9c512af97f"}}, PreviousHash: "7fbc21aa7a5d5aab5af7c446dab3daf3bf590ea2f9915e4a9ef2432fee0b5ad0"}, Proof: Proof{Nonce: 2248352, DifficultyThreshold: 5}}, Block{BlockHeader: BlockHeader{Timestamp: 1586119852, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Amount: 1000, Timestamp: 0, Signature: ""}, Transaction{Sender: "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0", Recipient: "046007e213c57ccab18af3f3b385893da75514ab691216152955d70937744dbe040de0ea504ebe29bce2476ae37c794cf5e7d96c8bc2ad153eb434b148f1af6f6c", Amount: 20, Timestamp: 1586119765, Signature: "3045022100e8cdfe3a9a87a2eda134f2fa34d286cfaeb1710bda348436f8fe177739444d0d0220089ef5c7e6aa1ce9c10ae2d217f833d0aab339cbefa81a7379f5957745302e02"}}, PreviousHash: "4a86c8870f5bbee49bb0184a0956df6bbea1a7d411a1f4dcb8fa31ed7a1ac5ca"}, Proof: Proof{Nonce: 970577, DifficultyThreshold: 5}}}

	// NOTE: The only reason we can pass a blank UTXO in all of these calls to ValidateBlock is because the miner of each block was the sender

	// Fully Valid Block
	validBlock, validUTXO := ValidateBlock(9, cleanChain, make(UTXO), validationServer)
	assert.True(t, validBlock)
	assert.Contains(t, validUTXO, "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0")
	assert.NotContains(t, validUTXO, "0")

	// Valid Genesis Block
	validGenesis, genesisUTXO := ValidateBlock(0, cleanChain, make(UTXO), validationServer)
	assert.True(t, validGenesis)
	assert.Contains(t, genesisUTXO, "0458adabe2c014de6c3fd2f2c865c2ca7fe823a4131a4d22f98dcc77f1bffc8aeacf8a0b7949321c33214e9c1b2201063404a321110be8223ad1685ee32c9c02d0")
	assert.NotContains(t, genesisUTXO, "0")

	// Invalid Genesis Block
	chain2 := copyChain(cleanChain)
	chain2[0] = Block{BlockHeader: BlockHeader{Timestamp: 1585852979, Transactions: []Transaction{Transaction{Sender: "0", Recipient: "NOTREALPERSON", Amount: 1, Timestamp: 1585852961, Signature: ""}}}}
	invalidGenesis, invalidGenesisUTXO := ValidateBlock(0, chain2, make(UTXO), validationServer)
	assert.False(t, invalidGenesis)
	assert.Nil(t, invalidGenesisUTXO)

	// Block With Only Coinbase Transaction
	chain3 := copyChain(cleanChain)
	chain3[1].Transactions = []Transaction{Transaction{Sender: "0", Recipient: "NOTREALPERSON", Amount: 1, Timestamp: 1585852961, Signature: ""}}
	blockWithOnlyGenesisTransactionValid, invalidBlockUTXO := ValidateBlock(1, chain3, make(UTXO), validationServer)
	assert.False(t, blockWithOnlyGenesisTransactionValid)
	assert.Nil(t, invalidBlockUTXO)

	// Block With Invalid Difficulty
	chain4 := copyChain(cleanChain)
	chain4[2].Proof.DifficultyThreshold = 999
	blockWithInvalidDifficulty, invalidDifficultyUTXO := ValidateBlock(2, chain4, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidDifficulty)
	assert.Nil(t, invalidDifficultyUTXO)

	// Block With Invalid Coinbase Transaction
	chain5 := copyChain(cleanChain)
	chain5[3].Transactions[0].Amount = coinbaseReward + 9999
	chain5[3].PreviousHash = chain5[2].hash()
	chain5[3].Proof.Nonce = 2245373

	blockWithInvalidCoinbaseTransaction, invalidCoinbaseUTXO := ValidateBlock(3, chain5, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidCoinbaseTransaction)
	assert.Nil(t, invalidCoinbaseUTXO)

	// Block With Invalid Previous Hash
	chain6 := copyChain(cleanChain)
	chain6[4].PreviousHash = "NOTVALID"
	chain6[4].Proof.Nonce = 6721917

	blockWithInvalidPreviousHash, invalidPreviousHashUTXO := ValidateBlock(4, chain6, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidPreviousHash)
	assert.Nil(t, invalidPreviousHashUTXO)

	// Block With Invalid Signature
	chain7 := copyChain(cleanChain)
	chain7[5].PreviousHash = chain7[4].hash()
	chain7[5].Transactions[1].Signature = "NOTVALID"
	chain7[5].Proof.Nonce = 879574

	blockWithInvalidSignature, invalidSignatureHashUTXO := ValidateBlock(5, chain7, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidSignature)
	assert.Nil(t, invalidSignatureHashUTXO)

	// Block With Duplicate Transaction
	chain8 := copyChain(cleanChain)
	chain8[6].PreviousHash = chain8[5].hash()
	chain8[6].Transactions[1] = chain8[2].Transactions[1]
	chain8[6].Proof.Nonce = 793188

	blockWithDuplicateTransaction, duplicateTransactionUTXO := ValidateBlock(6, chain8, make(UTXO), validationServer)
	assert.False(t, blockWithDuplicateTransaction)
	assert.Nil(t, duplicateTransactionUTXO)

	// Block With Transaction Where Sender Has 0 Coins
	chain9 := copyChain(cleanChain)
	chain9[1].PreviousHash = chain8[0].hash()
	chain9[1].Transactions[1] = Transaction{
		Sender:    "04a92df2046a9ee5fb621c0027ff1ec148cad1cda120571dfab3f3fce91a65cedcfcfe7b017331397e85d11ba488939a8206f419b0a50e87f33cb62d8d1d714c19",
		Recipient: "048f0e62afb1ac9002af6ee35013931bd2e75c368c4bd59c88eeb78a93263d006eed814196ce227ca701fdecd6e533013c11d2e6519fd1a8759694f6b512b28ca0",
		Amount:    10,
		Timestamp: 1588111338,
		Signature: "3046022100e8f60f9831b85cf7fe164166934bc4a87c3ba5d6090b1d43f56317bb199a4cd5022100d66c57380784581fe48fada6d29fc647ac52264120d257793461746874a4e0f0",
	}
	chain9[1].Proof.Nonce = 2027378

	blockWithInvalidTransaction, invalidTransactionUTXO := ValidateBlock(1, chain9, make(UTXO), validationServer)
	assert.False(t, blockWithInvalidTransaction)
	assert.Nil(t, invalidTransactionUTXO)
}
